name: Pipeline Completo de CI/CD del Ahorcado

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Permisos para que SonarCloud pueda comentar en Pull Requests
permissions:
  pull-requests: write

jobs:
  # ----------------------------------------------------
  # JOB 1: Unit Tests, Cobertura y SonarCloud
  # (Toma tu código y lo mejora)
  # ----------------------------------------------------
  test-and-analyze:
    name: 1. Unit Tests, Cobertura y SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout del código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para SonarCloud

      - name: 2. Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 3. Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # Usamos requirements-dev.txt como acordamos
          # Esto instala pytest, pytest-cov, flake8, behave, selenium, etc.
          pip install -r requirements-dev.txt

      - name: 4. Lint con Flake8 (Tu código) (Req 3)
        run: |
          # stop the build if there are Python syntax errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: 5. Ejecutar Unit Tests y Cobertura (Tu código) (Req 1 y 2)
        run: |
          # Usamos tu comando, que es perfecto
          pytest --cov=. --cov-report=xml --cov-report=term-missing
          # Esto crea 'coverage.xml'
          
      - name: 6. Ejecutar Análisis SonarCloud (Req 3)
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.TOKEN_REPO_AGILES }} # Usando tu nombre de secreto
        # No se necesita 'with:' porque tienes 'sonar-project.properties'

  # ----------------------------------------------------
  # JOB 2: Pruebas de Aceptación (ATDD) - ¡Este te faltaba!
  # (Cumple Req 4, 5, 6, 7, 10)
  # ----------------------------------------------------
  acceptance-test:
    name: 2. Pruebas de Aceptación (ATDD)
    runs-on: ubuntu-latest
    
    # 'needs:' es la clave. Este job NO COMENZARÁ
    # si el job 'test-and-analyze' falla.
    needs: test-and-analyze 

    steps:
      - name: 1. Checkout del código
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 3. Instalar todas las dependencias
        run: |
          pip install -r requirements-dev.txt
          pip install -r requirements.txt

      - name: 4. Instalar Google Chrome y ChromeDriver (para Selenium)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f 3 | cut -d '.' -f 1-3)
          DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
          wget -q "https://chromedriver.storage.googleapis.com/$DRIVER_VERSION/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/bin/chromedriver

      - name: 5. Ejecutar la Aplicación Flask (en background)
        env:
          FLASK_APP: app.py
        run: |
          flask run &
          sleep 5 # Dar tiempo a que el servidor inicie

      - name: 6. Ejecutar ATDD (Behave + Selenium)
        run: |
          # 'behave' buscará tus archivos .feature y correrá los tests
          behave features/
          # Si un AT (Scenario) falla, este comando fallará,
          # y el pipeline se detendrá aquí.

  # ----------------------------------------------------
  # JOB 3: Desplegar a Producción - ¡Este te faltaba!
  # (Cumple Req 9)
  # ----------------------------------------------------
  deploy:
    name: 3. Desplegar a Producción
    runs-on: ubuntu-latest
    
    # Este job SOLO se ejecuta si 'acceptance-test' fue exitoso
    needs: acceptance-test 
    # Y solo se ejecuta en la rama 'main' (no en Pull Requests)
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 1. Desplegar en Render
        run: |
          # Llama al Deploy Hook que creaste en Render
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
          # (Asegúrate de haber creado el secreto RENDER_DEPLOY_HOOK)